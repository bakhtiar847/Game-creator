<!doctype html>
<html lang="en">
<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width,initial-scale=1" />
	<title>Game Creator</title>
	<style>
		:root{
			--bg:#0f1724;
			--panel:#0b1220;
			--muted:#9aa8bf;
			--accent:#06b6d4;
			--accent-2:#22c55e;
			--glass: rgba(255,255,255,0.03);
			--rounded:12px;
			--height:64px;
		}
		html,body{height:100%;margin:0;background:linear-gradient(180deg,var(--bg),#021025 120%);font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;color:#e6eef8}
		/* Top bar */
		.topbar{
			height:var(--height);
			display:flex;
			align-items:center;
			justify-content:space-between;
			gap:16px;
			padding:8px 16px;
			background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent);
			border-bottom:1px solid rgba(255,255,255,0.03);
			backdrop-filter: blur(6px);
			position:sticky;top:0;z-index:50;
		}
		.topbar-left, .topbar-center, .topbar-right{display:flex;align-items:center;gap:12px}

		/* Project dropdown */
		.project-dropdown{position:relative}
		.proj-btn{
			display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:10px;background:var(--glass);border:1px solid rgba(255,255,255,0.03);cursor:pointer;color:var(--muted);
			font-weight:600;font-size:14px
		}
		.proj-btn .caret{width:0;height:0;border-left:6px solid transparent;border-right:6px solid transparent;border-top:6px solid var(--muted);opacity:0.9}
		.dropdown-panel{
			position:absolute;left:0;top:calc(100% + 10px);min-width:260px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(0,0,0,0.15));padding:12px;border-radius:12px;box-shadow:0 8px 30px rgba(2,6,23,0.6);border:1px solid rgba(255,255,255,0.04);display:none
		}
		.dropdown-panel.show{display:block}
		.proj-title{font-size:15px;font-weight:700;color:#f8fdff;margin-bottom:6px}
		.proj-meta{font-size:13px;color:var(--muted);line-height:1.3}

		/* Center tabs */
		.tabs{display:flex;gap:6px;align-items:center}
		.tab{
			padding:8px 14px;border-radius:999px;background:transparent;color:var(--muted);cursor:pointer;font-weight:600;font-size:14px;border:1px solid transparent;transition:all .15s ease
		}
		.tab:hover{background:rgba(255,255,255,0.02)}
		.tab.active{background:linear-gradient(90deg,var(--accent),#7c3aed);color:white;box-shadow:0 6px 18px rgba(7,89,133,0.18);transform:translateY(-1px)}

		/* Right run button */
		.run-btn{display:inline-flex;align-items:center;gap:10px;padding:10px 16px;border-radius:10px;background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#032024;font-weight:800;cursor:pointer;border:none;box-shadow:0 10px 30px rgba(6,182,212,0.18)}
		.run-btn .play{width:0;height:0;border-left:10px solid #032024;border-top:6px solid transparent;border-bottom:6px solid transparent}

		/* Small screens */
		@media (max-width:700px){
			.topbar-center{display:none}
			.proj-btn{padding:8px 10px}
		}

		/* Page content placeholder */
		main{padding:24px;height:calc(100vh - 80px);overflow:hidden}
		.panel{background:rgba(255,255,255,0.02);padding:20px;border-radius:12px;border:1px solid rgba(255,255,255,0.02);min-height:240px;height:100%}

		/* Files panel layout */
		.files-container{display:flex;gap:16px;height:calc(100vh - 200px)}
		.files-sidebar{flex:0 0 200px;background:rgba(255,255,255,0.01);border-radius:8px;padding:12px;border:1px solid rgba(255,255,255,0.02);overflow-y:auto}
		.files-main{flex:1;background:rgba(255,255,255,0.01);border-radius:8px;padding:12px;border:1px solid rgba(255,255,255,0.02);overflow-y:auto}
		.files-preview{flex:0 0 250px;background:rgba(255,255,255,0.01);border-radius:8px;padding:12px;border:1px solid rgba(255,255,255,0.02);display:flex;flex-direction:column}

		/* Assets panel layout: filters (left), library (center), preview (right) */
		.assets-container{display:flex;gap:12px;height:calc(100vh - 240px);margin-top:8px}
		.assets-filters{flex:0 0 220px;background:rgba(255,255,255,0.01);border-radius:8px;padding:12px;border:1px solid rgba(255,255,255,0.02);overflow:auto;display:flex;flex-direction:column;position:relative;transition:width .15s ease}
		.assets-filters.collapsed{width:40px;min-width:40px;padding-left:6px;padding-right:6px;overflow:hidden}
		.filters-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
		.filters-toggle{background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.04);padding:6px;border-radius:6px;cursor:pointer;color:var(--muted);font-weight:700}
		.filters-search{width:100%;padding:8px 10px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.03);border-radius:6px;color:#e6eef8;margin-bottom:8px}

		.assets-library{flex:1;min-width:220px;background:rgba(255,255,255,0.01);border-radius:8px;padding:12px;border:1px solid rgba(255,255,255,0.02);overflow:auto;display:flex;flex-direction:column}
		.assets-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:12px}
		.asset-item{background:rgba(255,255,255,0.02);border-radius:8px;padding:8px;display:flex;flex-direction:column;align-items:center;gap:8px;cursor:pointer;border:1px solid rgba(255,255,255,0.02)}
		.asset-thumb{width:100%;height:80px;background:rgba(0,0,0,0.2);border-radius:6px}

		.assets-preview{flex:0 0 300px;background:rgba(255,255,255,0.01);border-radius:8px;padding:12px;border:1px solid rgba(255,255,255,0.02);overflow:auto;display:flex;flex-direction:column}
		.assets-preview .preview-header{margin-bottom:12px}

		/* Resizer */
		.resizer{width:8px;cursor:col-resize;background:transparent;display:flex;align-items:center;justify-content:center;position:relative}
		.resizer:after{content:'';width:2px;height:40%;background:rgba(255,255,255,0.03);border-radius:2px}
		.resizer.dragging:after{background:var(--accent)}

		/* Folder tree */
		.folder-tree{list-style:none;padding:0;margin:0}
		.folder-tree-nested{list-style:none;padding-left:20px;margin:4px 0 0 0;display:none}
		.folder-tree-nested.expanded{display:block}
		.folder-item{padding:6px 0;cursor:pointer;color:var(--muted);font-size:13px;user-select:none;display:flex;align-items:center;gap:6px}
		.folder-item:hover{color:#e6eef8}
		.folder-toggle{width:12px;height:12px;display:inline-flex;align-items:center;justify-content:center;margin-right:4px;transition:transform .2s;font-size:10px}
		.folder-toggle.expanded{transform:rotate(90deg)}
		.folder-icon::before{content:"üìÅ "}
		.file-icon::before{content:"üìÑ "}

		/* Code file tree nested */
		.code-file-tree-nested{list-style:none;padding-left:20px;margin:4px 0 0 0;display:none}
		.code-file-tree-nested.expanded{display:block}

		/* File list */
		.file-item{padding:8px;margin:4px 0;background:rgba(255,255,255,0.03);border-radius:6px;cursor:pointer;border:1px solid rgba(255,255,255,0.02);transition:all .15s ease}
		.file-item:hover{background:rgba(255,255,255,0.08);border-color:rgba(255,255,255,0.08)}
		.file-item.selected{background:linear-gradient(90deg,var(--accent),#7c3aed);border-color:var(--accent)}
		.file-name{font-size:13px;font-weight:500}
		.file-type{font-size:11px;color:var(--muted)}

		/* Preview panel */
		.preview-header{font-weight:600;margin-bottom:12px;color:#f8fdff;font-size:13px}
		.preview-content{flex:1;overflow-y:auto;background:rgba(0,0,0,0.2);border-radius:6px;padding:12px;margin-bottom:12px;font-family:monospace;font-size:11px;line-height:1.5;white-space:pre-wrap;word-break:break-word}
		.open-btn{padding:10px 14px;background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#032024;border:none;border-radius:6px;cursor:pointer;font-weight:600;font-size:12px;width:100%}
		.open-btn:hover{opacity:0.9}
		.open-btn:disabled{opacity:0.5;cursor:not-allowed}

		/* Code panel layout */
		.code-container{display:flex;flex-direction:column;height:100%;width:100%}
		.code-modes{display:flex;gap:8px;margin-bottom:12px;border-bottom:1px solid rgba(255,255,255,0.05);padding-bottom:8px;flex-shrink:0}
		.code-mode-btn{padding:8px 14px;border:none;background:transparent;color:var(--muted);cursor:pointer;font-weight:600;font-size:13px;border-bottom:2px solid transparent;transition:all .15s ease}
		.code-mode-btn:hover{color:#e6eef8}
		.code-mode-btn.active{color:var(--accent);border-bottom-color:var(--accent)}

		/* Code editor layout */
		.code-editor-container{display:flex;gap:16px;flex:1;min-height:0}
		.code-sidebar{flex:0 0 200px;background:rgba(255,255,255,0.01);border-radius:8px;padding:12px;border:1px solid rgba(255,255,255,0.02);overflow-y:auto;display:flex;flex-direction:column}
		.code-sidebar-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;font-weight:600;font-size:13px;color:#f8fdff}
		.code-sidebar-create{padding:6px 10px;background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#032024;border:none;border-radius:5px;cursor:pointer;font-weight:600;font-size:11px}
		.code-file-tree{flex:1;overflow-y:auto;list-style:none;padding:0;margin:0}
		.code-file-item{padding:8px;margin:4px 0;background:rgba(255,255,255,0.02);border-radius:6px;cursor:pointer;border:1px solid rgba(255,255,255,0.02);display:flex;justify-content:space-between;align-items:center;transition:all .15s ease;font-size:12px}
		.code-file-item:hover{background:rgba(255,255,255,0.06);border-color:rgba(255,255,255,0.06)}
		.code-file-item.selected{background:linear-gradient(90deg,var(--accent),#7c3aed);border-color:var(--accent)}
		.code-file-item-name{flex:1}
		.code-file-actions{display:flex;gap:4px}
		.code-file-action-btn{padding:4px 6px;background:rgba(255,255,255,0.05);border:none;color:var(--muted);cursor:pointer;font-size:10px;border-radius:3px;transition:all .15s ease}
		.code-file-action-btn:hover{background:rgba(255,255,255,0.15);color:#e6eef8}

		.code-editor-main{flex:1;background:rgba(255,255,255,0.01);border-radius:8px;border:1px solid rgba(255,255,255,0.02);padding:12px;overflow:hidden;display:flex;flex-direction:column}
		.code-editor-header{font-weight:600;margin-bottom:12px;color:#f8fdff;font-size:13px}
		.code-editor{flex:1;background:rgba(0,0,0,0.2);border-radius:6px;padding:12px;font-family:'Monaco','Courier New',monospace;font-size:13px;color:#e6eef8;line-height:1.6;overflow:auto;border:1px solid rgba(255,255,255,0.02);resize:none}
		.code-editor::placeholder{color:var(--muted)}

		/* Dialog styles */
		.modal-overlay{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.6);z-index:100;align-items:center;justify-content:center}
		.modal-overlay.show{display:flex}
		.modal-dialog{background:linear-gradient(180deg,var(--panel),#0f1724);border:1px solid rgba(255,255,255,0.05);border-radius:12px;padding:24px;min-width:300px;box-shadow:0 20px 60px rgba(0,0,0,0.8)}
		.modal-dialog h3{margin:0 0 16px 0;color:#f8fdff;font-size:15px}
		.modal-dialog input{width:100%;padding:10px 12px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:6px;color:#e6eef8;font-size:13px;margin-bottom:16px;font-family:inherit}
		.modal-dialog input::placeholder{color:var(--muted)}
		.modal-dialog-actions{display:flex;gap:10px;justify-content:flex-end}
		.modal-btn{padding:8px 16px;border:none;border-radius:6px;cursor:pointer;font-weight:600;font-size:12px;transition:all .15s ease}
		.modal-btn-primary{background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#032024}
		.modal-btn-primary:hover{opacity:0.9}
		.modal-btn-secondary{background:rgba(255,255,255,0.05);color:#e6eef8;border:1px solid rgba(255,255,255,0.1)}
		/* Welcome modal */
		.welcome-overlay{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);z-index:200;align-items:center;justify-content:center}
		.welcome-overlay.show{display:flex}
		.welcome-dialog{background:linear-gradient(180deg,var(--panel),#0f1724);border:1px solid rgba(255,255,255,0.05);border-radius:12px;padding:32px;min-width:500px;max-width:700px;box-shadow:0 20px 60px rgba(0,0,0,0.8)}
		.welcome-title{font-size:28px;font-weight:700;color:#f8fdff;margin:0 0 8px 0}
		.welcome-subtitle{font-size:14px;color:var(--muted);margin-bottom:24px}
		.welcome-section{margin-bottom:24px}
		.welcome-section-title{font-size:13px;font-weight:600;color:#e6eef8;margin-bottom:12px}
		.welcome-buttons{display:flex;gap:12px;margin-bottom:24px}
		.welcome-btn{flex:1;padding:12px 16px;border-radius:8px;border:none;cursor:pointer;font-weight:600;font-size:14px;transition:all .15s ease}
		.welcome-btn-primary{background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#032024}
		.welcome-btn-primary:hover{opacity:0.9}
		.welcome-btn-secondary{background:rgba(255,255,255,0.05);color:#e6eef8;border:1px solid rgba(255,255,255,0.1)}
		.welcome-btn-secondary:hover{background:rgba(255,255,255,0.1)}
		.welcome-list{background:rgba(0,0,0,0.2);border-radius:8px;max-height:200px;overflow-y:auto;border:1px solid rgba(255,255,255,0.05)}
		.welcome-list-item{padding:10px 12px;border-bottom:1px solid rgba(255,255,255,0.02);cursor:pointer;color:#e6eef8;font-size:13px;transition:all .15s ease}
		.welcome-list-item:hover{background:rgba(255,255,255,0.05)}
		.welcome-list-item:last-child{border-bottom:none}
		.welcome-empty{padding:20px;text-align:center;color:var(--muted);font-size:13px}
		.welcome-search{width:100%;padding:10px 12px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:6px;color:#e6eef8;font-size:13px;margin-bottom:12px;font-family:inherit}
		.welcome-search::placeholder{color:var(--muted)}
		.welcome-back-btn{background:rgba(255,255,255,0.05);color:#e6eef8;border:1px solid rgba(255,255,255,0.1);padding:10px 14px;border-radius:6px;cursor:pointer;font-weight:600;font-size:12px;margin-top:12px}
		.welcome-back-btn:hover{background:rgba(255,255,255,0.1)}
	</style>
</head>
<body>
	<header class="topbar">
		<div class="topbar-left">
			<div class="project-dropdown">
				<button class="proj-btn" id="projToggle" aria-haspopup="true" aria-expanded="false">
					<span class="proj-name">My Game Project</span>
					<span class="caret" aria-hidden="true"></span>
				</button>
				<div class="dropdown-panel" id="projPanel" role="menu" aria-label="Project details">
					<div class="proj-title" id="projTitle">Loading...</div>
					<div class="proj-meta"><div id="projDescription" style="margin-top:8px">Description is loading...</div></div>
					<div style="margin-top:12px;display:flex;flex-direction:column;gap:8px">
						<button id="downloadProjectBtn" class="modal-btn modal-btn-primary" style="width:100%;background:linear-gradient(90deg,var(--accent),var(--accent-2));">‚¨á Download as JSON</button>
						<button id="uploadProjectBtn" class="modal-btn modal-btn-secondary" style="width:100%;background:rgba(255,255,255,0.05);color:#e6eef8;border:1px solid rgba(255,255,255,0.1)">‚¨Ü Upload JSON</button>
					</div>
				</div>
			</div>
		</div>

		<div class="topbar-center">
			<nav class="tabs" role="tablist" aria-label="Editor tabs">
				<button class="tab active" data-tab="assets" role="tab" aria-selected="true">Assets</button>
				<button class="tab" data-tab="world" role="tab" aria-selected="false">World</button>
				<button class="tab" data-tab="code" role="tab" aria-selected="false">Code</button>
				<button class="tab" data-tab="files" role="tab" aria-selected="false">Files</button>
				<button class="tab" data-tab="settings" role="tab" aria-selected="false">Settings</button>
			</nav>
		</div>

		<div class="topbar-right">
			<button class="run-btn" id="runBtn" title="Run project">
				<span class="play" aria-hidden="true"></span>
				<span style="font-weight:700;color:#002126">Run</span>
			</button>
		</div>
	</header>

	<main>
		<section class="panel" id="panelAssets" data-panel>
			<div style="display:flex;justify-content:space-between;align-items:center">
				<h3>Assets</h3>
				<p class="muted" style="margin:0">Manage your project's assets</p>
			</div>

			<div class="assets-container" id="assetsContainer">
				<!-- Left: Filters (collapsible) -->
				<div class="assets-filters" id="assetsFilters">
					<div class="filters-header">
						<span style="font-weight:700;color:#f8fdff">Filters</span>
						<button id="filtersToggle" class="filters-toggle" title="Collapse filters" aria-pressed="false">‚ùÆ</button>
					</div>
					<input id="assetSearch" class="filters-search" placeholder="Search assets..." />
					<div style="font-size:13px;color:var(--muted);margin-top:6px">
						<label><input type="checkbox" data-type="images" checked /> Images</label><br />
						<label><input type="checkbox" data-type="objects" checked /> Objects</label><br />
						<label><input type="checkbox" data-type="inventory" checked /> Inventory Items</label><br />
					<label><input type="checkbox" data-type="tools" checked /> Tools</label>
					</div>
				</div>

				<!-- Resizer between filters and library -->
				<div class="resizer" id="resizerLeft" title="Resize filters" role="separator" aria-orientation="vertical" tabindex="0"></div>

				<!-- Center: Library -->
				<div class="assets-library" id="assetsLibrary">
					<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
						<div style="font-weight:600;color:#f8fdff;font-size:13px">Library</div>
						<button class="open-btn" id="uploadAssetBtn">Upload</button>
					</div>
					<div class="assets-grid" id="assetsGrid">
						<div class="asset-item" data-asset="sample1" data-type="images">
							<div class="asset-thumb"></div>
							<div style="font-size:12px">Sample Image</div>
						</div>
						<div class="asset-item" data-asset="sample2" data-type="objects">
							<div class="asset-thumb"></div>
							<div style="font-size:12px">Game Object</div>
						</div>
						<div class="asset-item" data-asset="sample3" data-type="tools">
							<div class="asset-thumb"></div>
							<div style="font-size:12px">Sample Tool</div>
						</div>
					</div>
				</div>

				<!-- Resizer between library and preview -->
				<div class="resizer" id="resizerRight" title="Resize preview" role="separator" aria-orientation="vertical" tabindex="0"></div>

				<!-- Right: Preview -->
				<div class="assets-preview" id="assetsPreview">
					<div class="preview-header">Preview</div>
					<div class="preview-content" id="assetsPreviewContent">Select an asset to preview</div>
					<button class="open-btn" id="assetsOpenBtn" disabled>Open</button>
				</div>
			</div>
		</section>
		<section class="panel" id="panelWorld" data-panel style="display:none;margin-top:16px">
			<h3>World</h3>
			<p class="muted">Configure the world and scenes.</p>
		</section>
		<section class="panel" id="panelCode" data-panel style="display:none;margin-top:16px;padding:0">
			<div class="code-container">
				<div class="code-modes">
					<button class="code-mode-btn active" data-mode="text">Text Editor</button>
					<button class="code-mode-btn" data-mode="blocks">Blocks <span style="font-size:10px;opacity:0.7">(coming soon)</span></button>
				</div>
				<div class="code-editor-container">
					<!-- Left sidebar: File tree -->
					<div class="code-sidebar">
						<div class="code-sidebar-header">
							<span>Scripts</span>
							<button class="code-sidebar-create" id="createScriptBtn">+ New</button>
						</div>
						<ul class="code-file-tree" id="codeFileTree"></ul>
					</div>

					<!-- Center: Code editor -->
					<div class="code-editor-main">
						<div class="code-editor-header" id="codeEditorHeader">Select a file to edit</div>
						<textarea class="code-editor" id="codeEditorTextarea" placeholder="Select a file to start editing..."></textarea>
					</div>
				</div>
			</div>
		</section>
		<section class="panel" id="panelFiles" data-panel style="display:none;margin-top:16px;padding:0">
			<div class="files-container">
				<!-- Left sidebar: Folder tree -->
				<div class="files-sidebar">
					<div style="font-weight:600;margin-bottom:12px;color:#f8fdff;font-size:13px">Folders</div>
					<ul class="folder-tree" id="folderTree"></ul>
				</div>

				<!-- Middle: File list -->
				<div class="files-main">
					<div class="files-main-header" style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
						<div style="font-weight:600;color:#f8fdff;font-size:13px">Files</div>
						<button id="createFileBtn" style="padding:6px 10px;background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#032024;border:none;border-radius:5px;cursor:pointer;font-weight:600;font-size:11px">Create</button>
					</div>
					<div id="fileList"></div>
				</div>

				<!-- Right: Preview panel -->
				<div class="files-preview">
					<div class="preview-header">Preview</div>
					<div class="preview-content" id="previewContent">Select a file to preview</div>
					<button class="open-btn" id="openBtn" disabled>Open</button>
				</div>
			</div>
		</section>
		<section class="panel" id="panelSettings" data-panel style="display:none;margin-top:16px">
			<h3>Settings</h3>
			<p class="muted">Project and editor settings.</p>
		</section>
	</main>

	<!-- Dialog for naming -->
	<div class="modal-overlay" id="nameDialog">
		<div class="modal-dialog">
			<h3 id="dialogTitle">New Script</h3>
			<input type="text" id="dialogInput" placeholder="Enter name..." />
			<select id="dialogType" style="width:100%;padding:10px 12px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:6px;color:#e6eef8;font-size:13px;margin-bottom:16px;font-family:inherit">
				<option value="javascript">JavaScript</option>
				<option value="plaintext">Plain Text</option>
				<option value="htmlnote">HTML Note</option>
				<option value="folder">Folder</option>
			</select>
			<div class="modal-dialog-actions">
				<button class="modal-btn modal-btn-secondary" id="dialogCancel">Cancel</button>
				<button class="modal-btn modal-btn-primary" id="dialogConfirm">Create</button>
			</div>
		</div>
	</div>

	<!-- Welcome modal -->
	<div class="welcome-overlay" id="welcomeOverlay">
		<div class="welcome-dialog">
			<h1 class="welcome-title">Game Creator</h1>
			<p class="welcome-subtitle">Create and manage your game projects</p>
			
			<div class="welcome-section">
				<div class="welcome-buttons">
					<button class="welcome-btn welcome-btn-primary" id="welcomeNewBtn">+ New Project</button>
					<button class="welcome-btn welcome-btn-secondary" id="welcomeOpenBtn">üìÅ Open Project</button>
				</div>
			</div>

			<div id="welcomeMainView">
				<div class="welcome-section">
					<div class="welcome-section-title">Recently Opened</div>
					<div class="welcome-list" id="recentList">
						<div class="welcome-empty">No recent projects</div>
					</div>
				</div>
			</div>

			<div id="welcomeNewView" style="display:none">
				<div class="welcome-section">
					<label style="font-size:13px;color:#e6eef8;display:block;margin-bottom:8px">Project Name</label>
					<input type="text" id="newProjectInput" placeholder="Enter project name..." class="welcome-search" style="margin-bottom:0" />
				</div>
				<div style="display:flex;gap:8px">
					<button class="welcome-btn welcome-btn-primary" id="welcomeCreateBtn" style="flex:1">Create</button>
					<button class="welcome-back-btn" id="welcomeNewBackBtn" style="flex:0;margin-top:0">‚Üê Back</button>
				</div>
			</div>

			<div id="welcomeOpenView" style="display:none">
				<div class="welcome-section">
					<input type="text" id="projectSearchInput" placeholder="Search projects..." class="welcome-search" />
					<div class="welcome-list" id="projectList">
						<div class="welcome-empty">No projects found</div>
					</div>
				</div>
				<div style="display:flex;gap:8px">
					<button class="welcome-btn welcome-btn-secondary" id="welcomeUploadBtn" style="flex:1">‚¨Ü Upload JSON</button>
					<button class="welcome-back-btn" id="welcomeOpenBackBtn">‚Üê Back</button>
				</div>
			</div>
		</div>
	</div>

	<script>
		// Recently opened projects management
		function getRecentProjects() {
			const recent = localStorage.getItem('recentProjects');
			return recent ? JSON.parse(recent) : [];
		}

		function addToRecent(projectName) {
			const recent = getRecentProjects();
			// Remove if already exists, add to front
			const filtered = recent.filter(p => p !== projectName);
			filtered.unshift(projectName);
			// Keep only last 10
			localStorage.setItem('recentProjects', JSON.stringify(filtered.slice(0, 10)));
		}

		function getAllProjects() {
			const projects = [];
			for(let i = 0; i < localStorage.length; i++) {
				const key = localStorage.key(i);
				// Exclude system keys
				if(key && !['recentProjects'].includes(key)) {
					try {
						const data = localStorage.getItem(key);
						if(data && data.startsWith('[')) {
							// It's a FileList (JSON array)
							projects.push(key);
						}
					} catch(e) {}
				}
			}
			return projects;
		}

		// Welcome modal management
		function showWelcome() {
			const overlay = document.getElementById('welcomeOverlay');
			if(overlay) {
				overlay.classList.add('show');
				renderRecentProjects();
			}
		}

		function hideWelcome() {
			const overlay = document.getElementById('welcomeOverlay');
			if(overlay) {
				overlay.classList.remove('show');
			}
		}

		function renderRecentProjects() {
			const recentList = document.getElementById('recentList');
			const recent = getRecentProjects();
			if(recent.length === 0) {
				recentList.innerHTML = '<div class="welcome-empty">No recent projects</div>';
			} else {
				recentList.innerHTML = recent.map((name, idx) => {
					return `<div class="welcome-list-item" data-project-index="recent-${idx}">${name}</div>`;
				}).join('');
				// Attach event listeners
				recentList.querySelectorAll('.welcome-list-item').forEach((item, idx) => {
					item.addEventListener('click', () => openProject(recent[idx]));
				});
			}
		}

		function renderAllProjects(filter = '') {
			const projectList = document.getElementById('projectList');
			const allProjects = getAllProjects();
			const filtered = filter ? allProjects.filter(p => p.toLowerCase().includes(filter.toLowerCase())) : allProjects;
			
			if(filtered.length === 0) {
				projectList.innerHTML = '<div class="welcome-empty">No projects found</div>';
			} else {
				projectList.innerHTML = filtered.map(name => {
					return `<div class="welcome-list-item" data-project-name="${name}">${name}</div>`;
				}).join('');
				// Attach event listeners
				projectList.querySelectorAll('.welcome-list-item').forEach(item => {
					const projectName = item.getAttribute('data-project-name');
					item.addEventListener('click', () => openProject(projectName));
				});
			}
		}

		function openProject(projectName) {
			addToRecent(projectName);
			const encoded = encodeURIComponent(projectName);
			window.location.href = `?projName=${encoded}`;
		}

		function switchWelcomeView(view) {
			const mainView = document.getElementById('welcomeMainView');
			const newView = document.getElementById('welcomeNewView');
			const openView = document.getElementById('welcomeOpenView');

			mainView.style.display = 'none';
			newView.style.display = 'none';
			openView.style.display = 'none';

			if(view === 'main') {
				mainView.style.display = 'block';
				renderRecentProjects();
			} else if(view === 'new') {
				newView.style.display = 'block';
				setTimeout(() => document.getElementById('newProjectInput').focus(), 100);
			} else if(view === 'open') {
				openView.style.display = 'block';
				renderAllProjects();
				setTimeout(() => document.getElementById('projectSearchInput').focus(), 100);
			}
		}

		var ProjectName = "New Game Project";
		
		// Storage utilities
		function saveProjectToStorage() {
			const storageKey = ProjectName;
			try {
				localStorage.setItem(storageKey, JSON.stringify(FileList));
				console.log(`Project "${ProjectName}" saved to localStorage`);
			} catch(err) {
				console.error('Failed to save project to localStorage:', err);
			}
		}

		function renameProjectInStorage(oldName, newName) {
			try {
				const projectData = localStorage.getItem(oldName);
				if(projectData) {
					localStorage.setItem(newName, projectData);
					localStorage.removeItem(oldName);
					console.log(`Project renamed from "${oldName}" to "${newName}" in localStorage`);
				}
			} catch(err) {
				console.error('Failed to rename project in localStorage:', err);
			}
		}

		function downloadProjectAsJSON() {
			try {
				const projectData = {
					name: ProjectName,
					fileList: FileList,
					exportDate: new Date().toISOString()
				};
				const jsonString = JSON.stringify(projectData, null, 2);
				const blob = new Blob([jsonString], { type: 'application/json' });
				const url = URL.createObjectURL(blob);
				const link = document.createElement('a');
				link.href = url;
				link.download = `${ProjectName.replace(/\s+/g, '_')}_${Date.now()}.json`;
				document.body.appendChild(link);
				link.click();
				document.body.removeChild(link);
				URL.revokeObjectURL(url);
			} catch(err) {
				console.error('Failed to download project:', err);
				alert('Failed to download project');
			}
		}

		function triggerUploadDialog() {
			const input = document.createElement('input');
			input.type = 'file';
			input.accept = '.json';
			input.addEventListener('change', (e) => {
				const file = e.target.files[0];
				if(file) {
					const reader = new FileReader();
					reader.onload = (event) => {
						try {
							const content = event.target.result;
							const projectData = JSON.parse(content);
							
							// Extract filename without extension
							const filename = file.name.replace(/\.json$/i, '');
							
							// Save to localStorage
							if(projectData.fileList) {
								localStorage.setItem(filename, JSON.stringify(projectData.fileList));
								console.log(`Project "${filename}" imported and saved to localStorage`);
								
								// Redirect to the project
								const encoded = encodeURIComponent(filename);
								window.location.href = `?projName=${encoded}`;
							} else {
								alert('Invalid project format: missing fileList property');
							}
						} catch(err) {
							console.error('Failed to parse JSON:', err);
							alert('Invalid project JSON file');
						}
					};
					reader.readAsText(file);
				}
			});
			input.click();
		}

		// Parse URL parameters (comma-separated key=value pairs)
		function getURLParams() {
			const queryString = window.location.search.substring(1); // Remove the '?'
			const params = {};
			if(queryString) {
				const pairs = queryString.split(',');
				pairs.forEach(pair => {
					const [key, value] = pair.split('=');
					if(key && value) {
						params[decodeURIComponent(key.trim())] = decodeURIComponent(value.trim());
					}
				});
			}
			return params;
		}

		// Initialize default FileList
		let defaultFileList = [
			{name : "Project", type : "folder", children : [
				{name : "Scripts", type : "folder", children : [
					{name : "main", type : "javascript", content : 
`function initUser(){
	// setup code can go here
	console.log("Hello, world!");
}

function loopUser(){
	// custom code can go here
}
`},
				]},
				{name : "assets", type : "folder", children : []},
				{name : "notes", type : "folder", children : [
					{name : "welcome", type : "htmlnote", content : "<html><head><title>Welcome</title></head><body><h1>Welcome to the Game Creator!</h1></body></html>"},
					{name : "main", type : "plaintext", content : "Put your notes here..."},
					{name : "description", type : "plaintext", content : "No description provided."}]},
				{name : "world", type : "folder", children : []},
				{name : "settings", type : "folder", children : []}
			]}
			];

		// Load project from URL params or storage
		const urlParams = getURLParams();
		let FileList;
		let isProjectLoaded = false;
		
		if(urlParams.projName) {
			ProjectName = decodeURIComponent(urlParams.projName);
			const storedProject = localStorage.getItem(ProjectName);
			if(storedProject) {
				try {
					FileList = JSON.parse(storedProject);
					console.log(`Loaded project "${ProjectName}" from localStorage`);
					isProjectLoaded = true;
					addToRecent(ProjectName);
				} catch(err) {
					console.error('Failed to parse stored project:', err);
					FileList = defaultFileList;
				}
			} else {
				console.log(`Project "${ProjectName}" not found in storage, using default`);
				FileList = defaultFileList;
				isProjectLoaded = true;
			}
		} else {
			FileList = defaultFileList;
		}

		// Show welcome screen if no project is loaded
		if(!isProjectLoaded) {
			document.addEventListener('DOMContentLoaded', showWelcome);
			// Also show immediately if DOM is already loaded
			if(document.readyState === 'loading') {
				document.addEventListener('DOMContentLoaded', showWelcome);
			} else {
				showWelcome();
			}
		}

		// Helper: find description file (notes/description)
		function findDescriptionFile(){
			const project = FileList[0];
			if(!project) return null;
			const notes = project.children.find(c=>c.name === 'notes');
			if(!notes || !notes.children) return null;
			return notes.children.find(c=>c.name === 'description');
		}

		function updateProjectPanel(){
			const nameEl = document.querySelector('.proj-name');
			const titleEl = document.getElementById('projTitle');
			const descEl = document.getElementById('projDescription');
			if(nameEl) nameEl.textContent = ProjectName;
			if(titleEl) titleEl.textContent = ProjectName;
			const descFile = findDescriptionFile();
			if(descEl) descEl.textContent = descFile ? (descFile.content || '(No description)') : 'Description not found';
		}

		function isDescriptionFile(file){
			return file && file.name === 'description';
		}

		// Files panel functionality
		(function(){
			const folderTree = document.getElementById('folderTree');
			const fileList = document.getElementById('fileList');
			const previewContent = document.getElementById('previewContent');
			const openBtn = document.getElementById('openBtn');
			const createFileBtn = document.getElementById('createFileBtn');

			let currentFolder = FileList[0]; // Project

			// Render folder tree recursively
			function renderFolderTree(){
				folderTree.innerHTML = '';
				FileList.forEach(item => {
					folderTree.appendChild(createFolderNode(item));
				});
			}

			function createFolderNode(item){
				const li = document.createElement('li');
				
				const folder = document.createElement('div');
				folder.className = 'folder-item';
				
				const hasChildren = item.children && item.children.length > 0;
				if(hasChildren){
					const toggle = document.createElement('span');
					toggle.className = 'folder-toggle';
					toggle.textContent = '‚ñ∂';
					folder.appendChild(toggle);
				}
				
				const icon = document.createElement('span');
				icon.className = 'folder-icon';
				folder.appendChild(icon);
				
				const name = document.createElement('span');
				name.textContent = item.name;
				folder.appendChild(name);
				
				li.appendChild(folder);
				
				if(hasChildren){
					const toggle = folder.querySelector('.folder-toggle');
					const nested = document.createElement('ul');
					nested.className = 'folder-tree-nested';
					
					item.children.forEach(child => {
						nested.appendChild(createTreeNode(child));
					});
					
					li.appendChild(nested);
					
					toggle.addEventListener('click', e => {
						e.stopPropagation();
						nested.classList.toggle('expanded');
						toggle.classList.toggle('expanded');
					});
				}
				
				folder.addEventListener('click', () => {
					selectedFile = null;
					currentFolder = item;
					const files = item.children || [];
					renderFileList(files);
					previewContent.textContent = 'Select a file to preview';
					openBtn.disabled = true;
				});
				
				return li;
			}

			function createTreeNode(item){
				if(item.type === 'folder'){
					return createFolderNode(item);
				} else {
					const li = document.createElement('li');
					const file = document.createElement('div');
					file.className = 'folder-item';
					
					const icon = document.createElement('span');
					icon.className = 'file-icon';
					file.appendChild(icon);
					
					const name = document.createElement('span');
					name.textContent = item.name;
					file.appendChild(name);
					
					file.addEventListener('click', () => {
						selectedFile = item;
						if (item.type === 'htmlnote') {
							previewContent.innerHTML = item.content || '(No content)';
						} else {
							previewContent.textContent = item.content || '(No content)';
						}
						openBtn.disabled = false;
						document.querySelectorAll('.file-item').forEach(f => f.classList.remove('selected'));
					});
					
					li.appendChild(file);
					return li;
				}
			}

 			// Render file list
			function renderFileList(files){
				fileList.innerHTML = '';
				files.forEach(file => {
					const div = document.createElement('div');
					div.className = 'file-item';
					
					if(file.type === 'folder'){
						div.innerHTML = '<div class="file-name"><span class="folder-icon"></span>' + file.name + '</div><div class="file-type">folder</div>';
						div.addEventListener('click', () => {
							document.querySelectorAll('.file-item').forEach(f => f.classList.remove('selected'));
							div.classList.add('selected');
							selectedFile = null;
							renderFileList(file.children || []);
							previewContent.textContent = 'Select a file to preview';
							openBtn.disabled = true;
						});
					} else {
						div.innerHTML = '<div class="file-name"><span class="file-icon"></span>' + file.name + '</div><div class="file-type">' + file.type + '</div>';
						div.addEventListener('click', () => {
							document.querySelectorAll('.file-item').forEach(f => f.classList.remove('selected'));
							div.classList.add('selected');
							selectedFile = file;
							if (file.type === 'htmlnote') {
								previewContent.innerHTML = file.content || '(No content)';
							} else {
								previewContent.textContent = file.content || '(No content)';
							}
							openBtn.disabled = false;
						});
						div.addEventListener('dblclick', () => {
							if(selectedFile && (selectedFile.type === 'javascript' || selectedFile.type === 'plaintext' || selectedFile.type === 'htmlnote')){
								const codeTab = document.querySelector('[data-tab="code"]');
								codeTab.click();
								setTimeout(() => {
									loadFileIntoEditor(selectedFile);
								}, 100);
							}
						});
					}
					
					fileList.appendChild(div);
				});
			}

			// Initial render
			renderFolderTree();

			// Create button
			createFileBtn.addEventListener('click', () => {
				window.showCreateDialog('files');
			});

			// Open button - launch code editor if javascript, plaintext, or htmlnote
			openBtn.addEventListener('click', () => {
				if(selectedFile && (selectedFile.type === 'javascript' || selectedFile.type === 'plaintext' || selectedFile.type === 'htmlnote')){
					// Switch to Code tab and load file
					const codeTab = document.querySelector('[data-tab="code"]');
					codeTab.click();
					// Load file into editor after tab switches
					setTimeout(() => {
						loadFileIntoEditor(selectedFile);
					}, 100);
				}
			});

			function createFileInFolder(name, type){
				let newItem;
				if(type === 'folder'){
					newItem = {name, type: 'folder', children: []};
				} else {
					newItem = {name, type, content: type === 'javascript' ? `// ${name}\nconsole.log('Hello from ${name}!');` : ''};
				}
				currentFolder.children.push(newItem);
				// Re-render
				if(currentFolder === FileList[0]){
					renderFolderTree();
				} else {
					renderFileList(currentFolder.children);
				}
				saveProjectToStorage();
			}

			window.createFileInFolder = createFileInFolder;
		})();

		// Ensure project panel is populated on load
		updateProjectPanel();

		/* Assets panel interactivity: collapse filters and resize side panels */
		(function(){
			const filtersEl = document.getElementById('assetsFilters');
			const resizerLeft = document.getElementById('resizerLeft');
			const resizerRight = document.getElementById('resizerRight');
			const previewEl = document.getElementById('assetsPreview');
			const libraryEl = document.getElementById('assetsLibrary');
			const filtersToggle = document.getElementById('filtersToggle');
			const assetSearch = document.getElementById('assetSearch');
			const assetsGrid = document.getElementById('assetsGrid');
			const assetsPreviewContent = document.getElementById('assetsPreviewContent');
			const assetsOpenBtn = document.getElementById('assetsOpenBtn');
			const uploadAssetBtn = document.getElementById('uploadAssetBtn');

			if(!filtersEl) return;

			// Collapse/expand filters
			filtersToggle.addEventListener('click', () => {
				const collapsed = filtersEl.classList.toggle('collapsed');
				filtersToggle.setAttribute('aria-pressed', String(collapsed));
				filtersToggle.textContent = collapsed ? '‚ùØ' : '‚ùÆ';
				if(!collapsed){
					const saved = filtersEl.dataset.savedWidth;
					if(saved) filtersEl.style.flex = '0 0 ' + saved + 'px';
				} else {
					filtersEl.dataset.savedWidth = filtersEl.getBoundingClientRect().width;
					filtersEl.style.flex = '0 0 40px';
				}
			});

			// Generic resize helper
			function initResize(resizer, onMove){
				let dragging = false;
				let startX = 0;
				function onDown(e){
					dragging = true;
					startX = e.clientX || (e.touches && e.touches[0].clientX);
					resizer.classList.add('dragging');
					document.addEventListener('mousemove', onMoveInternal);
					document.addEventListener('mouseup', onUp);
					document.addEventListener('touchmove', onMoveInternal, {passive:false});
					document.addEventListener('touchend', onUp);
					document.body.style.userSelect = 'none';
				}
				function onMoveInternal(e){
					if(!dragging) return;
					const clientX = e.clientX || (e.touches && e.touches[0].clientX);
					const dx = clientX - startX;
					onMove(dx);
				}
				function onUp(){
					dragging = false;
					resizer.classList.remove('dragging');
					document.removeEventListener('mousemove', onMoveInternal);
					document.removeEventListener('mouseup', onUp);
					document.removeEventListener('touchmove', onMoveInternal);
					document.removeEventListener('touchend', onUp);
					document.body.style.userSelect = '';
				}
				resizer.addEventListener('mousedown', onDown);
				resizer.addEventListener('touchstart', onDown, {passive:true});
			}

			// Left resizer: adjust filters width
			initResize(resizerLeft, (dx) => {
				const startWidth = parseFloat(filtersEl.style.flexBasis || filtersEl.getBoundingClientRect().width);
				let newWidth = startWidth + dx;
				newWidth = Math.max(40, Math.min(480, newWidth));
				filtersEl.style.flex = '0 0 ' + newWidth + 'px';
			});

			// Right resizer: adjust preview width
			initResize(resizerRight, (dx) => {
				const startWidth = parseFloat(previewEl.style.flexBasis || previewEl.getBoundingClientRect().width);
				let newWidth = startWidth - dx;
				newWidth = Math.max(160, Math.min(700, newWidth));
				previewEl.style.flex = '0 0 ' + newWidth + 'px';
			});

			// Asset selection handling
			assetsGrid.addEventListener('click', (e) => {
				const assetItem = e.target.closest('.asset-item');
				if(!assetItem) return;
				document.querySelectorAll('#assetsGrid .asset-item').forEach(it => it.classList.remove('selected'));
				assetItem.classList.add('selected');
				assetsPreviewContent.textContent = 'Previewing: ' + (assetItem.dataset.asset || assetItem.textContent.trim());
				assetsOpenBtn.disabled = false;
			});

			// Simple upload - add placeholder asset
			uploadAssetBtn.addEventListener('click', () => {
				const name = prompt('Asset name');
				if(!name) return;
				const div = document.createElement('div');
				div.className = 'asset-item';
				div.setAttribute('data-asset', name);
				div.innerHTML = '<div class="asset-thumb"></div><div style="font-size:12px">'+name+'</div>';
				div.setAttribute('data-type', 'images');
				assetsGrid.prepend(div);
				filterAssets();
			});

// Search & type filtering
				function filterAssets(){
					const q = assetSearch.value.trim().toLowerCase();
					const checkedTypes = Array.from(document.querySelectorAll('#assetsFilters input[type="checkbox"]:checked')).map(cb => cb.getAttribute('data-type'));
					document.querySelectorAll('#assetsGrid .asset-item').forEach(it => {
						const label = it.textContent.toLowerCase();
						const t = it.getAttribute('data-type') || 'images';
						const matchesQuery = !q || label.includes(q);
						const matchesType = checkedTypes.length === 0 || checkedTypes.includes(t);
						it.style.display = (matchesQuery && matchesType) ? '' : 'none';
					});
				}
				assetSearch.addEventListener('input', filterAssets);
				document.querySelectorAll('#assetsFilters input[type="checkbox"]').forEach(cb => cb.addEventListener('change', filterAssets));

			// Keyboard support for resizers
			[resizerLeft, resizerRight].forEach(r => {
				if(!r) return;
				r.addEventListener('keydown', (e) => {
					if(e.key === 'ArrowLeft' || e.key === 'ArrowRight'){
						e.preventDefault();
						const step = (e.shiftKey ? 20 : 8) * (e.key === 'ArrowLeft' ? -1 : 1);
						if(r === resizerLeft){
							const cur = parseFloat(filtersEl.style.flexBasis || filtersEl.getBoundingClientRect().width);
							const nw = Math.max(40, Math.min(480, cur + step));
							filtersEl.style.flex = '0 0 ' + nw + 'px';
						} else {
							const cur = parseFloat(previewEl.style.flexBasis || previewEl.getBoundingClientRect().width);
							const nw = Math.max(160, Math.min(700, cur + step));
							previewEl.style.flex = '0 0 ' + nw + 'px';
						}
					}
				});
			});

		})();

		// Code panel functionality
		(function(){
			const codeFileTree = document.getElementById('codeFileTree');
			const codeEditorTextarea = document.getElementById('codeEditorTextarea');
			const codeEditorHeader = document.getElementById('codeEditorHeader');
			const createScriptBtn = document.getElementById('createScriptBtn');
			const nameDialog = document.getElementById('nameDialog');
			const dialogInput = document.getElementById('dialogInput');
			const dialogTitle = document.getElementById('dialogTitle');
			const dialogConfirm = document.getElementById('dialogConfirm');
			const dialogCancel = document.getElementById('dialogCancel');
			const modeBtns = document.querySelectorAll('.code-mode-btn');

			let currentEditingFile = null;
			let dialogMode = 'create'; // 'create', 'rename'
			let dialogContext = 'code';

			window.dialogMode = dialogMode;
			window.dialogContext = dialogContext;

			// Get Scripts folder from FileList
			function getScriptsFolder(){
				const project = FileList[0];
				return project.children.find(c => c.name === 'Scripts');
			}

			// Render code file tree
			function renderCodeFileTree(){
				codeFileTree.innerHTML = '';
				const scripts = getScriptsFolder();
				if(scripts && scripts.children){
					scripts.children.forEach(child => {
						codeFileTree.appendChild(createCodeTreeNode(child));
					});
				}
			}

			function createCodeTreeNode(item){
				const li = document.createElement('li');
				if(item.type === 'folder'){
					const folder = document.createElement('div');
					folder.className = 'code-file-item';
					
					const toggle = document.createElement('span');
					toggle.className = 'folder-toggle';
					toggle.textContent = '‚ñ∂';
					folder.appendChild(toggle);
					
					const icon = document.createElement('span');
					icon.className = 'folder-icon';
					folder.appendChild(icon);
					
					const name = document.createElement('span');
					name.textContent = item.name;
					folder.appendChild(name);
					
					li.appendChild(folder);
					
					const nested = document.createElement('ul');
					nested.className = 'code-file-tree-nested';
					if(item.children){
						item.children.forEach(child => {
							nested.appendChild(createCodeTreeNode(child));
						});
					}
					li.appendChild(nested);
					
					toggle.addEventListener('click', e => {
						e.stopPropagation();
						nested.classList.toggle('expanded');
						toggle.classList.toggle('expanded');
					});
				} else {
					const div = document.createElement('div');
					div.className = 'code-file-item';
					
					const nameSpan = document.createElement('span');
					nameSpan.className = 'code-file-item-name';
					nameSpan.textContent = item.name;
					
					const actionsDiv = document.createElement('div');
					actionsDiv.className = 'code-file-actions';
					
					const renameBtn = document.createElement('button');
					renameBtn.className = 'code-file-action-btn';
					renameBtn.textContent = '‚úèÔ∏è';
					renameBtn.title = 'Rename';
					renameBtn.addEventListener('click', (e) => {
						e.stopPropagation();
						showRenameDialog(item);
					});
					
					const deleteBtn = document.createElement('button');
					deleteBtn.className = 'code-file-action-btn';
					deleteBtn.textContent = 'üóëÔ∏è';
					deleteBtn.title = 'Delete';
					deleteBtn.addEventListener('click', (e) => {
						e.stopPropagation();
						deleteFile(item);
					});
					
					actionsDiv.appendChild(renameBtn);
					actionsDiv.appendChild(deleteBtn);
					
					div.appendChild(nameSpan);
					div.appendChild(actionsDiv);
					
					div.addEventListener('click', () => {
						document.querySelectorAll('.code-file-item').forEach(f => f.classList.remove('selected'));
						div.classList.add('selected');
						currentEditingFile = item;
						codeEditorHeader.textContent = item.name;
						codeEditorTextarea.value = item.content || '';
					});
					
					li.appendChild(div);
				}
				return li;
			}

			function showCreateDialog(context = 'code'){
				window.dialogMode = 'create';
				window.dialogContext = context;
				dialogTitle.textContent = context === 'code' ? 'New Script' : 'New File/Folder';
				dialogInput.value = '';
				dialogInput.placeholder = 'Enter name...';
				// Populate type options
				const dialogType = document.getElementById('dialogType');
				dialogType.innerHTML = '';
				if(context === 'code'){
					dialogType.innerHTML = '<option value="javascript">JavaScript</option><option value="folder">Folder</option>';
					dialogType.value = 'javascript';
				} else {
					dialogType.innerHTML = '<option value="folder">Folder</option><option value="javascript">JavaScript</option><option value="plaintext">Plain Text</option><option value="htmlnote">HTML Note</option>';
					dialogType.value = 'plaintext';
				}
				nameDialog.classList.add('show');
				dialogInput.focus();
			}

			window.showCreateDialog = showCreateDialog;

			function showRenameDialog(file){
				window.dialogMode = 'rename';
				dialogTitle.textContent = 'Rename Script';
				dialogInput.value = file.name;
				dialogInput.placeholder = 'Enter new name...';
				currentEditingFile = file;
				nameDialog.classList.add('show');
				dialogInput.select();
			}

			function deleteFile(file){
				const scripts = getScriptsFolder();
				if(scripts){
					const idx = scripts.children.indexOf(file);
					if(idx > -1){
						scripts.children.splice(idx, 1);
						renderCodeFileTree();
						if(currentEditingFile === file){
							currentEditingFile = null;
							codeEditorHeader.textContent = 'Select a file to edit';
							codeEditorTextarea.value = '';
						}
						saveProjectToStorage();
					}
				}
			}

			function createNewFile(name, type){
				const scripts = getScriptsFolder();
				if(scripts){
					let newItem;
					if(type === 'folder'){
						newItem = {name, type: 'folder', children: []};
					} else {
						newItem = {name, type, content: type === 'javascript' ? `// ${name}\nconsole.log('Hello from ${name}!');` : ''};
					}
					scripts.children.push(newItem);
					renderCodeFileTree();
					saveProjectToStorage();
				}
			}

			window.createNewFile = createNewFile;

			function renameScript(newName){
				if(currentEditingFile){
					currentEditingFile.name = newName;
					codeEditorHeader.textContent = newName;
					renderCodeFileTree();
					saveProjectToStorage();
				}
			}

			// Dialog handlers
			dialogConfirm.addEventListener('click', () => {
				const name = dialogInput.value.trim();
				const dialogTypeEl = document.getElementById('dialogType');
				const type = dialogTypeEl ? dialogTypeEl.value : 'plaintext';
				if(name){
					if(window.dialogMode === 'create'){
						if(window.dialogContext === 'code'){
							window.createNewFile(name, type);
						} else {
							window.createFileInFolder(name, type);
						}
					} else if(window.dialogMode === 'rename'){
						if(window.dialogContext === 'project'){
							const oldName = ProjectName;
							ProjectName = name;
							renameProjectInStorage(oldName, name);
							updateProjectPanel();
						} else {
							renameScript(name);
						}
					}
					if(dialogTypeEl) dialogTypeEl.style.display = '';
					nameDialog.classList.remove('show');
				}
			});

			dialogCancel.addEventListener('click', () => {
				nameDialog.classList.remove('show');
			});

			nameDialog.addEventListener('click', (e) => {
				if(e.target === nameDialog){
					nameDialog.classList.remove('show');
				}
			});

			dialogInput.addEventListener('keypress', (e) => {
				if(e.key === 'Enter'){
					dialogConfirm.click();
				}
			});

			// Create button
			createScriptBtn.addEventListener('click', () => showCreateDialog('code'));

			// Mode buttons (blocks is disabled for now)
			modeBtns.forEach(btn => {
				btn.addEventListener('click', () => {
					if(btn.dataset.mode === 'blocks'){
						return; // Blocks not available yet
					}
					modeBtns.forEach(b => b.classList.remove('active'));
					btn.classList.add('active');
				});
			});

			// Save on textarea change and update project description when appropriate
			codeEditorTextarea.addEventListener('input', () => {
				if(currentEditingFile){
					currentEditingFile.content = codeEditorTextarea.value;
					if(isDescriptionFile(currentEditingFile)){
						updateProjectPanel();
					}
					saveProjectToStorage();
				}
			});

			// Initial render
			renderCodeFileTree();

			// Ensure project panel updates if user opens/edits description from code editor
			const renameProjectBtn = document.getElementById('renameProjectBtn');
			if(renameProjectBtn){
				renameProjectBtn.addEventListener('click', () => {
					window.dialogMode = 'rename';
					window.dialogContext = 'project';
					dialogTitle.textContent = 'Rename Project';
					dialogInput.value = ProjectName;
					dialogInput.placeholder = 'Enter new project name...';
					const dialogTypeEl = document.getElementById('dialogType');
					if(dialogTypeEl) dialogTypeEl.style.display = 'none';
					nameDialog.classList.add('show');
					dialogInput.focus();
					dialogInput.select();
				});
			}

			// Expose function for files panel to use
			window.loadFileIntoEditor = function(file){
				if(file.type === 'javascript' || file.type === 'plaintext' || file.type === 'htmlnote'){
					document.querySelectorAll('.code-file-item').forEach(f => f.classList.remove('selected'));
					currentEditingFile = file;
					codeEditorHeader.textContent = file.name;
					codeEditorTextarea.value = file.content || '';
				}
			};
		})();

		// Dropdown toggle
		(function(){
			const toggle = document.getElementById('projToggle');
			const panel = document.getElementById('projPanel');
			const downloadBtn = document.getElementById('downloadProjectBtn');
			const uploadBtn = document.getElementById('uploadProjectBtn');

			toggle.addEventListener('click', e=>{
				const show = !panel.classList.contains('show');
				panel.classList.toggle('show', show);
				toggle.setAttribute('aria-expanded', String(show));
			});
			document.addEventListener('click', e=>{
				if(!toggle.contains(e.target) && !panel.contains(e.target)){
					panel.classList.remove('show');
					toggle.setAttribute('aria-expanded','false');
				}
			});

			// Download button
			if(downloadBtn) {
				downloadBtn.addEventListener('click', (e) => {
					e.stopPropagation();
					downloadProjectAsJSON();
				});
			}

			// Upload button
			if(uploadBtn) {
				uploadBtn.addEventListener('click', (e) => {
					e.stopPropagation();
					triggerUploadDialog();
				});
			}
		})();

		// Tabs behavior
		(function(){
			const tabs = Array.from(document.querySelectorAll('.tab'));
			const panels = Array.from(document.querySelectorAll('[data-panel]'));
			function activate(tab){
				tabs.forEach(t=>{t.classList.toggle('active', t===tab); t.setAttribute('aria-selected', String(t===tab));});
				const name = tab.dataset.tab;
				panels.forEach(p=>p.style.display = p.id === 'panel'+name.charAt(0).toUpperCase()+name.slice(1) ? 'block' : 'none');
			}
			tabs.forEach(t=>t.addEventListener('click', ()=>activate(t)));
		})();

		// Run button with loader, window management, and state tracking
		let gameWindow = null;
		const runBtn = document.getElementById('runBtn');

		function GenerateUserCode(){
			return "// === COMPILE/USERCODESTART ===\n" + PrepareUserData() + "\n// === COMPILE/USERCODEEND ===";
		}

		function PrepareUserData(){
			const scripts = PrepareScripts();
			const assets = PrepareAssets();
			// Return code that will execute all scripts
			return `
${scripts}

// COMPILE/ASSETDATASTART

${assets}
`;
		}

		function PrepareScripts(){
			const scripts = FileList[0].children.find(c => c.name === 'Scripts');
			if(!scripts || !scripts.children){
				return '';
			}
			return scripts.children
				.filter(file => file.type === 'javascript')
				.map(file => file.content || '')
				.join('\n\n// == COMPILER/SCRIPTSEPERATOR ==\n\n');
		}

		function PrepareAssets(){
			
		}

		// Prepare the player.html code
		async function prepareCode(){
			runBtn.innerHTML = '<span style="display:inline-block;width:16px;height:16px;border:2px solid rgba(3,32,36,0.3);border-top-color:#032024;border-radius:50%;animation:spin 0.8s linear infinite"></span>';
			try {
				const response = await fetch('./player.html');
				let html = await response.text();
				// Inject user code between compile markers
				const userCode = GenerateUserCode();
				html = html.replace(
					/\/\/\s*===\s*COMPILE\/USERCODESTART\s*===[\s\S]*?\/\/\s*===\s*COMPILE\/USERCODEEND\s*===/, userCode
				);
				return html;
			} catch(err) {
				console.error('Failed to load player.html:', err);
				runBtn.innerHTML = '<span class="play" aria-hidden="true"></span><span style="font-weight:700;color:#002126">Run</span>';
				alert("Failed to run the game. Please check your internet connection and try again.");
				return null;
			}
		}

		// Run the game in a new window
		async function run(){
			if(gameWindow && !gameWindow.closed){
				gameWindow.close();
				gameWindow = null;
				runBtn.innerHTML = '<span class="play" aria-hidden="true"></span><span style="font-weight:700;color:#002126">Run</span>';
				return;
			}

			const htmlContent = await prepareCode();
			if(!htmlContent) return;

			gameWindow = window.open('', 'gameWindow', 'width=1200,height=800');
			gameWindow.document.write(htmlContent);
			gameWindow.document.close();

			runBtn.innerHTML = '<span class="play" aria-hidden="true"></span><span style="font-weight:700;color:#002126">Running...</span>';

			// Monitor window closure
			const checkWindow = setInterval(()=>{
				if(gameWindow.closed){
					clearInterval(checkWindow);
					gameWindow = null;
					runBtn.innerHTML = '<span class="play" aria-hidden="true"></span><span style="font-weight:700;color:#002126">Run</span>';
				}
			}, 500);
		}

		// Add CSS animation for loader
		const style = document.createElement('style');
		style.textContent = '@keyframes spin { to { transform: rotate(360deg); } }';
		document.head.appendChild(style);

		// Welcome screen event listeners
		function setupWelcomeListeners() {
			const welcomeNewBtn = document.getElementById('welcomeNewBtn');
			const welcomeOpenBtn = document.getElementById('welcomeOpenBtn');
			const welcomeCreateBtn = document.getElementById('welcomeCreateBtn');
			const welcomeNewBackBtn = document.getElementById('welcomeNewBackBtn');
			const welcomeOpenBackBtn = document.getElementById('welcomeOpenBackBtn');
			const welcomeUploadBtn = document.getElementById('welcomeUploadBtn');
			const newProjectInput = document.getElementById('newProjectInput');
			const projectSearchInput = document.getElementById('projectSearchInput');

			if(welcomeNewBtn) {
				welcomeNewBtn.addEventListener('click', () => {
					switchWelcomeView('new');
				});
			}

			if(welcomeOpenBtn) {
				welcomeOpenBtn.addEventListener('click', () => {
					switchWelcomeView('open');
				});
			}

			if(welcomeCreateBtn) {
				welcomeCreateBtn.addEventListener('click', () => {
					const name = newProjectInput.value.trim();
					if(!name) {
						alert('Please enter a project name');
						return;
					}
					const exists = getAllProjects().includes(name);
					if(exists) {
						alert('A project with this name already exists. Please choose a different name.');
						newProjectInput.value = '';
						newProjectInput.focus();
					} else {
						openProject(name);
					}
				});
			}

			if(newProjectInput) {
				newProjectInput.addEventListener('keypress', (e) => {
					if(e.key === 'Enter') {
						welcomeCreateBtn.click();
					}
				});
			}

			if(welcomeNewBackBtn) {
				welcomeNewBackBtn.addEventListener('click', () => {
					switchWelcomeView('main');
				});
			}

			if(welcomeOpenBackBtn) {
				welcomeOpenBackBtn.addEventListener('click', () => {
					switchWelcomeView('main');
				});
			}

			if(projectSearchInput) {
				projectSearchInput.addEventListener('input', (e) => {
					renderAllProjects(e.target.value);
				});
			}

			if(welcomeUploadBtn) {
				welcomeUploadBtn.addEventListener('click', () => {
					triggerUploadDialog();
				});
			}
		}

		// Setup welcome listeners when DOM is ready
		if(document.readyState === 'loading') {
			document.addEventListener('DOMContentLoaded', setupWelcomeListeners);
		} else {
			setupWelcomeListeners();
		}

		runBtn.addEventListener('click', run);
	</script>
</body>
</html>

